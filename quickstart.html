<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="en" lang="en" data-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started</title>

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="nimdoc.out.css?v=2.1.1">

<!-- JS -->
<script type="text/javascript" src="dochack.js?v=2.1.1"></script>
</head>
<body>
  <div class="document" id="documentId">
    <div class="container">
      <h1 class="title">Getting Started</h1>
      <div class="row">
  <div class="three columns">
    <div class="theme-select-wrapper">
      <label for="theme-select">Theme:&nbsp;</label>
      <select id="theme-select" onchange="setTheme(this.value)">
        <option value="auto">ðŸŒ— Match OS</option>
        <option value="dark">ðŸŒ‘ Dark</option>
        <option value="light">ðŸŒ• Light</option>
      </select>
    </div>
    <div id="global-links">
      <ul class="simple">
        <li><a id="indexLink" href="theindex.html">Index</a></li>
      </ul>
    </div>
    <div id="searchInputDiv">
      Search: <input type="search" id="searchInput" oninput="search()"/>
    </div>
    <div>
      Group by:
      <select onchange="groupBy(this.value)">
        <option value="section">Section</option>
        <option value="type">Type</option>
      </select>
    </div>
    <ul class="simple simple-toc" id="toc-list">
  <li><a class="reference" id="introduction_toc" href="#introduction">Introduction</a></li>
<li><a class="reference" id="deferred_toc" href="#deferred">Deferred</a></li>
<li><a class="reference" id="core-api_toc" href="#core-api">Core API</a></li>
<ul class="simple"><li><a class="reference" id="core-api-then_toc" href="#core-api-then">then</a></li>
<li><a class="reference" id="core-api-except_toc" href="#core-api-except">except</a></li>
<li><a class="reference" id="core-api-done_toc" href="#core-api-done">done</a></li>
<li><a class="reference" id="core-api-next_toc" href="#core-api-next">next</a></li>
<li><a class="reference" id="core-api-timeout_toc" href="#core-api-timeout">timeout</a></li>
</ul><li><a class="reference" id="utilities_toc" href="#utilities">Utilities</a></li>
<ul class="simple"><li><a class="reference" id="utilities-delay_toc" href="#utilities-delay">delay</a></li>
<li><a class="reference" id="utilities-recover_toc" href="#utilities-recover">recover</a></li>
<li><a class="reference" id="utilities-retry_toc" href="#utilities-retry">retry</a></li>
<li><a class="reference" id="utilities-validation_toc" href="#utilities-validation">validation</a></li>
</ul><li><a class="reference" id="control-flow_toc" href="#control-flow">Control Flow</a></li>
<ul class="simple"><li><a class="reference" id="control-flow-join_toc" href="#control-flow-join">join</a></li>
<li><a class="reference" id="control-flow-abort_toc" href="#control-flow-abort">abort</a></li>
</ul><li><a class="reference" id="concurrency_toc" href="#concurrency">Concurrency</a></li>
<ul class="simple"><li><a class="reference" id="concurrency-all_toc" href="#concurrency-all">all</a></li>
<li><a class="reference" id="concurrency-race_toc" href="#concurrency-race">race</a></li>
<li><a class="reference" id="concurrency-any_toc" href="#concurrency-any">any</a></li>
<li><a class="reference" id="concurrency-allsettled_toc" href="#concurrency-allsettled">allSettled</a></li>
</ul><li><a class="reference" id="memory-model_toc" href="#memory-model">Memory Model</a></li>
<li><a class="reference" id="other-instructions_toc" href="#other-instructions">Other Instructions</a></li>
<ul class="simple"><li><a class="reference" id="other-instructions-requirements_toc" href="#other-instructions-requirements">Requirements</a></li>
<li><a class="reference" id="other-instructions-resources_toc" href="#other-instructions-resources">resources</a></li>
</ul>
</ul>

  </div>
  <div class="nine columns" id="content">
    
    <div id="tocRoot"></div>
    
    <p class="module-desc"><table class="docinfo" frame="void" rules="none"><col class="docinfo-name" /><col class="docinfo-content" /><tbody valign="top"><tr><th class="docinfo-name">Version:</th><td>5.0.6</td></tr>
<tr><th class="docinfo-name">Date:</th><td>2022-09</td></tr>
</tbody></table>
<h1><a class="toc-backref" id="introduction" href="#introduction">Introduction</a></h1><p>Asynchronous and concurrency are a major problem in programming. In order to solve this problem, asynchronous task control mechanisms are provided in various languages or libraries. Java provides support for Future through standard library. <tt class="docutils literal"><span class="pre"><span class="Identifier">Future</span></span></tt> was introduced in 1.5, and <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> was introduced in JDK 8, further improving the Future mechanism.</p>
<p><pre class="listing">
<span class="Identifier">CompletableFuture</span><span class="Operator">&lt;</span><span class="Identifier">HistoryData</span><span class="Operator">&gt;</span> <span class="Identifier">tag</span> <span class="Operator">=</span> <span class="Identifier">previousTag</span><span class="Punctuation">.</span><span class="Identifier">thenCompose</span><span class="Punctuation">(</span><span class="Keyword">this</span><span class="Punctuation">:</span><span class="Punctuation">:</span><span class="Identifier">toNow</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Keyword">return</span> <span class="Identifier">tag</span><span class="Punctuation">.</span><span class="Identifier">thenCompose</span><span class="Punctuation">(</span><span class="Identifier">hd</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">Objects</span><span class="Punctuation">.</span><span class="Identifier">isNull</span><span class="Punctuation">(</span><span class="Identifier">hd</span><span class="Punctuation">)</span> <span class="Operator">||</span> <span class="Identifier">CollectionUtils</span><span class="Punctuation">.</span><span class="Identifier">isEmpty</span><span class="Punctuation">(</span><span class="Identifier">hd</span><span class="Punctuation">.</span><span class="Identifier">getInfos</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Keyword">return</span> <span class="Identifier">getHistoryFromStore</span><span class="Punctuation">(</span><span class="Identifier">hd</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span>
    <span class="Keyword">return</span> <span class="Identifier">CompletableFuture</span><span class="Punctuation">.</span><span class="Identifier">completedFuture</span><span class="Punctuation">(</span><span class="Identifier">hd</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>However, after adopting the Future programming mode, new complexities are introduced, and some of the original pain points are still unresolved, especially:</p>
<ul class="simple"><li>Programming style converting from imperative programming to declarative programming. Declarative programming is usually not intuitive and the cost of understanding is high.</li>
<li>The conversion between synchronous semantics and asynchronous semantics is not easy. Future's API has a high learning cost. For example, the various combination methods of CompletableFuture are very complex and hard to understand.</li>
<li>Error handling is still complex. Future usually contains Running/Cancelled/Failed/Done states, and some states are handled through exceptions. It is still tedious to handle errors completely.</li>
<li>Future is not convenient for testing intermediate states. For a chained Future, it is usually not convenient to specify the asynchronous execution order to detect possible concurrency errors. Of course, this is a difficulty common to all concurrent programming.</li>
</ul>
<p>In order to further reduce the difficulty of asynchronous and concurrency control, we learn from the designs of other languages and implement the Promise mechanism in Java. That is, when executing an asynchronous task, the promise (Promise) will return the execution result at a certain point in time. This represents an unknown result. The entity is called a Promise. Using Promise abstraction can greatly reduce the mental burden on developers, greatly improve coding efficiency, and reduce the possibility of errors.</p>
<p>Let's first look at a code snippet using Promise to implement multi-threaded computing tasks for computationally intensive tasks.</p>
<p><pre class="listing">
<span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">Integer</span><span class="Operator">&gt;</span> <span class="Identifier">promise</span> <span class="Operator">=</span> <span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">resolve</span><span class="Punctuation">(</span><span class="DecNumber">0</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Keyword">int</span> <span class="Identifier">i</span> <span class="Operator">=</span> <span class="DecNumber">0</span><span class="Punctuation">;</span>
<span class="Keyword">do</span> <span class="Punctuation">{</span>
    <span class="Keyword">int</span> <span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">i</span><span class="Punctuation">;</span>
    <span class="Identifier">promise</span> <span class="Operator">=</span> <span class="Identifier">promise</span><span class="Punctuation">.</span><span class="Identifier">next</span><span class="Punctuation">(</span><span class="Identifier">n</span> <span class="Operator">-&gt;</span> <span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">resolve</span><span class="Punctuation">(</span><span class="Identifier">n</span> <span class="Operator">+</span> <span class="Identifier">c</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span> <span class="Keyword">while</span> <span class="Punctuation">(</span><span class="Operator">++</span><span class="Identifier">i</span> <span class="Operator">&lt;=</span> <span class="DecNumber">100</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Keyword">int</span> <span class="Identifier">val</span> <span class="Operator">=</span> <span class="Identifier">promise</span><span class="Punctuation">.</span><span class="Identifier">join</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Identifier">assertThat</span><span class="Punctuation">(</span><span class="Identifier">val</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">isEqualTo</span><span class="Punctuation">(</span><span class="DecNumber">5050</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>We can see that compared to weakly typed languages such as Javascript, Java is strongly typed. (<tt class="docutils literal"><span class="pre"><span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span></span></tt> should be read as <tt class="docutils literal"><span class="pre"><span class="Identifier">Promise</span> <span class="Keyword">of</span> <span class="Identifier">String</span></span></tt>). Using the generic mechanism can make code writing safer and more convenient. In addition, Javascript does not support multi-threading. The Promise component we designed naturally supports multi-threading.</p>
<p>In the above example, each accumulated operation is executed in a different thread. We have built in two simple and general thread pools. By default, Promise uses <tt class="docutils literal"><span class="pre"><span class="Identifier">ForkJoinPool</span></span></tt> as the thread pool, which is suitable for computing-intensive tasks. For blocking IO types, you can use the built-in <tt class="docutils literal"><span class="pre"><span class="Identifier">Promise</span><span class="Operator">.</span><span class="Identifier">ThreadPerTaskExecutor</span></span></tt>, a simple thread pool model. If you need a more complex strategy, you can use a custom thread pool and pass it in the constructor.</p>
<p>For different scenarios, we abstract an asynchronous task into two types in design, one is suitable for most scenarios and requires regular tasks that need to be executed immediately, which we call <tt class="docutils literal"><span class="pre"><span class="Identifier">Promise</span></span></tt>, and the other is asynchronous that needs to be executed with delay. Tasks are called <a class="reference internal" href="#deferred">Deferred</a>.</p>

<h1><a class="toc-backref" id="deferred" href="#deferred">Deferred</a></h1><p><span id="deferred_1">Deferred</span> is a Promise that is not executed immediately, realizing the separation of <strong>data consumption</strong> and <strong>data acquisition</strong>.</p>
<p><pre class="listing">
<span class="Comment">// Generate a promise object</span>
<span class="Identifier">Deferred</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span> <span class="Identifier">deferred</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">Deferred</span><span class="Operator">&lt;&gt;</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Comment">//data consumption</span>
<span class="Identifier">deferred</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//The value of s is something, s is processed here</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Comment">//data collection</span>
<span class="Identifier">deferred</span><span class="Punctuation">.</span><span class="Identifier">offer</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Comment">//There is no order requirement for the above two steps, and the execution results are consistent.</span>
<span class="Comment">//Because the state of the promise object is cached, many problems caused by timing are reduced.</span></pre></p>
<p>Normally, data acquisition and consumption are usually written together, but upon careful analysis we find that these are actually two completely different things.</p>
<p>For example, in the factory production line, if workers are not only responsible for processing goods (data consumption), but also responsible for picking up the goods to be processed (data acquisition), this is usually the practice of small workshops. In a professional assembly line, each worker only needs to simply complete the process he is responsible for while waiting for the product to be delivered to him. The small workshop approach increases the mental burden on workers, makes them more prone to errors, and reduces the efficiency of the assembly line.</p>
<p><tt class="docutils literal"><span class="pre"><span class="Identifier">Deferred</span></span></tt> helps us abstract this process, complete the separation of data acquisition and data processing, and better fulfill the idea of <tt class="docutils literal"><span class="pre"><span class="Identifier">Single</span> <span class="Identifier">Responsibility</span> <span class="Punctuation">(</span><span class="Identifier">SRP</span><span class="Punctuation">)</span></span></tt>.</p>
<p>In practice, for example, if a function interface returns a String, it means that the function caller can use the String immediately. If you want to express the semantics of using String in the future, there is nothing you can do. <strong>Deferred</strong> provides this semantics. The semantics it expresses is that a String will be provided in the future. As for who will provide this String and how to obtain this String, that is completely another matter. No data processor is required. Care, the data processor only needs to know how to process this data and send it to the next process.</p>
<p>Since <strong>Deferred</strong> is also a <strong>Promise</strong>, it fully possesses the capabilities of Promise. Compared with Promise, Deferred only has one more <strong>Initialized</strong> state, as shown below</p>
<p><pre class="listing">
                   +-------------------+
                   |                   |
   Deferred-------&gt;|    Initialized    |
                   |                   |
                   +---------+---------+
                             |
+----------------------------+---------------------------+
|                            |                           |
|                  +---------v---------+                 |
|                  |                   |                 |
|   Promise-------&gt;|      Pending      |                 |
|                  |                   |                 |
|                  +---------+---------+                 |
|                            |                           |
|   +----------------+       |        +---------------+  |
|   |                |       |        |               |  |
|   |    Resovled    &lt;-------+--------&gt;    Rejected   |  |
|   |                |                |               |  |
|   +-------+--------+                +--------+------+  |
|           |                                  |         |
|           |        +---------------+         |         |
|           |        |               |         |         |
|           +--------&gt;     Done      &lt;---------+         |
|                    |               |                   |
|                    +---------------+                   |
|                                                        |
+--------------------------------------------------------+</pre></p>

<h1><a class="toc-backref" id="core-api" href="#core-api">Core API</a></h1><p>In just a few minutes, mastering the usage of the following core interfaces will help you get twice the result with half the effort in your daily work.</p>

<h2><a class="toc-backref" id="core-api-then" href="#core-api-then">then</a></h2><p><span id="then_1">then</span> The method is executed when the previous asynchronous operation is successful and returns a new Promise.</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
      <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// s is something</span>
    <span class="Comment">// TODO processes something</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>

<h2><a class="toc-backref" id="core-api-except" href="#core-api-except">except</a></h2><p><span id="except_1">except</span> Contrary to then, it is executed when the asynchronous operation fails and returns a new Promise.</p>
<p><pre class="listing">
  <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
      <span class="Comment">// reject.apply(result);</span>
  <span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
      <span class="Comment">// s is something</span>
      <span class="Comment">// Processing logic when TODO fails</span>
  <span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>Using the above two interfaces, a simple asynchronous task processing process can be implemented. Under Android, it can replace <a class="reference external" href="https://developer.android.com/reference/android/os/AsyncTask">AsyncTask</a>.</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
      <span class="Comment">// Execute asynchronous tasks</span>
      <span class="Comment">// If successful, call resolve to change the state</span>
      <span class="Comment">// If it fails, call reject to change the state</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//Processing on success</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
      <span class="Comment">// Handling on failure</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>Of course, since each interface of Promise returns a new Promise, you can also write it like this</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//Execute asynchronous tasks</span>
      <span class="Comment">// If successful, call resolve to change the state</span>
      <span class="Comment">// If it fails, call reject to change the status</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
      <span class="Comment">// Handling on failure</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
      <span class="Comment">// Processing on success</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>It has no impact on the execution results. By now, you have mastered the basic usage of Promise.</p>

<h2><a class="toc-backref" id="core-api-done" href="#core-api-done">done</a></h2><p><span id="done_1">done</span> Executed when the status of the previous asynchronous operation is determined (success or failure), and returns a new Promise. In some scenarios, we don't care whether the asynchronous task succeeds or fails, such as data reporting, but we just need to perform some operations when the task is completed.</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//Execute asynchronous tasks</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">done</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//The asynchronous task is completed, whether it is successful or failed</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<blockquote class="markdown-quote"><p>Note: Once the state of a promise is determined, it will not change its own state and its data. This is different from a state machine.</p></blockquote>
<p>Since each interface of Promise returns a new Promise object, it allows us to perform chain operations and solves the &quot;callback hell&quot; problem caused by conventional callback-based programming. The above two code snippets will both return a new Promise object, whose type is <tt class="docutils literal"><span class="pre"><span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">Integer</span><span class="Operator">&gt;</span></span></tt>. The above interface can meet the processing flow of a single asynchronous task. In actual situations, asynchronous tasks often have serial and parallel requirements. Promise has powerful abstract description capabilities for asynchronous operations, allowing us to combine asynchronous task processing flows.</p>
<p>Let's look at a common situation <strong>Serial Combination</strong>. Here we need to introduce a new interface <a class="reference internal" href="#core-api-next">next</a>. For more advanced combination methods, please refer to <a class="reference internal" href="#Concurrency Control">Concurrency Control</a></p>

<h2><a class="toc-backref" id="core-api-next" href="#core-api-next">next</a></h2><p><span id="next_1">next</span> The operation is executed when the previous asynchronous operation is successful, receives the result of the previous step, initiates the next new asynchronous task, returns the Promise of the task, and can perform data type conversion.</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">next</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">Integer</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="Identifier">o</span><span class="Punctuation">.</span><span class="Identifier">length</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">integer</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// integer is 9</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>In actual situations, the asynchronous processing process may fail due to various reasons, so we'd better add an exception handling branch.</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">next</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">Integer</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="Identifier">o</span><span class="Punctuation">.</span><span class="Identifier">length</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">integer</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// integer is 9</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//Processing flow in case of failure</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>

<h2><a class="toc-backref" id="core-api-timeout" href="#core-api-timeout">timeout</a></h2><p>The Promise A+ specification does not define a standard processing method for timeout (<span id="timeout_1">timeout</span> ), but timeout processing is very common in actual business environments, so we have extended the specification and built-in support for timeout. In the following code, if the asynchronous task is not completed within 1 second (resolve or reject is actively called), the Promise will automatically enter the error state (reject state).<blockquote class="markdown-quote"><p>Delayed operations, such as timers, are generally the source of application memory leaks. If Promise reverses the state (resolve or reject) before the timer ends, the timer will be automatically canceled to avoid memory leaks.</p></blockquote>
</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Must call resolve or reject within the specified time to deliver the result</span>
    <span class="Comment">// otherwise it will automatically change to reject state</span>
<span class="Punctuation">}</span><span class="Punctuation">,</span> <span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofSeconds</span><span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">err</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Error handling process</span>
    <span class="Comment">// If no task is completed within 1s, err is PromiseTimeoutException</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Processing on success</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>The above is the core interface of Promise.</p>

<h1><a class="toc-backref" id="utilities" href="#utilities">Utilities</a></h1><p>The following interfaces provide capabilities that are often used in practice. Such interfaces are wrappers of the core API.</p>

<h2><a class="toc-backref" id="utilities-delay" href="#utilities-delay">delay</a></h2><p>We can very simply add <span id="delay_1">delay</span> delay execution effect to any Promise object, which can replace <tt class="docutils literal"><span class="pre"><span class="Identifier">Thread</span><span class="Operator">.</span><span class="Identifier">sleep</span></span></tt>. This interface returns a new Promise with delay effect added.</p>
<p>Specific examples of usage</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">delay</span><span class="Punctuation">(</span><span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofMillis</span><span class="Punctuation">(</span><span class="DecNumber">500</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//Delay 500ms to receive results</span>
    <span class="Comment">// o is something</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span></pre></p>
<p>Or in the form of static methods, the essence is the same.</p>
<p><pre class="listing">
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">delay</span><span class="Punctuation">(</span><span class="Identifier">aPromise</span><span class="Punctuation">,</span> <span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofMillis</span><span class="Punctuation">(</span><span class="Identifier">delay</span><span class="Punctuation">)</span><span class="Punctuation">)</span></pre></p>
<p>You can also use deferred operations as the starting point for business logic.</p>
<p><pre class="listing">
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">delay</span><span class="Punctuation">(</span><span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofMillis</span><span class="Punctuation">(</span><span class="DecNumber">500</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">next</span><span class="Punctuation">(</span><span class="Identifier">unused</span> <span class="Operator">-&gt;</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//Delay 500ms to receive results</span>
    <span class="Comment">// o is something</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>

<h2><a class="toc-backref" id="utilities-recover" href="#utilities-recover">recover</a></h2><p>It is very simple to add exception recovery logic <span id="recover_1">recover</span> to any Promise object. Executed when the previous asynchronous operation fails, receives the error message of the previous step, executes a new asynchronous task to obtain the same type of data, and returns the Promise of the task.</p>
<p>Common application scenarios:</p>
<ul class="simple"><li>Failed to read cache, reading from network</li>
<li>Network error, switch IP and try again</li>
</ul>
<p>This method is similar to the <tt class="docutils literal"><span class="pre"><span class="Identifier">next</span></span></tt> interface, the differences are as follows</p>
<table border="1" class="docutils"><tr><th>Interface</th><th>Execution timing</th><th>Data type</th></tr>
<tr><td><strong>next</strong></td><td>Executed when the previous step is successful</td><td><strong>can</strong> return a Promise with a different data type** from the previous step</td></tr>
<tr><td><strong>recover</strong></td><td>Executed when the previous step fails</td><td><strong>Must</strong> return a Promise of the same data type** as the previous step</td></tr>
</table><p>Typical usage:</p>
<p><pre class="listing">
<span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Identifier">reject</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;error&quot;</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
<span class="Punctuation">.</span><span class="Identifier">recover</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
<span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// s is something</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span></pre></p>
<p>Or in the form of a static method</p>
<p><pre class="listing">
<span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span> <span class="Identifier">aPromise</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Identifier">reject</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;error&quot;</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Comment">//Error recovery</span>
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">recover</span><span class="Punctuation">(</span><span class="Identifier">aPromise</span><span class="Punctuation">,</span> <span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
<span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//s is something</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span></pre></p>
<p>Because recover also returns a new Promise object, it can implement very flexible recovery logic, such as multiple attempts, or adding delay and other strategies. Please refer to <a class="reference internal" href="#utilities-retry">retry</a>.</p>

<h2><a class="toc-backref" id="utilities-retry" href="#utilities-retry">retry</a></h2><p><span id="retry_1">retry</span> it is to execute the recovery process with a certain strategy. We can add a retry strategy to an asynchronous task very simply.</p>
<p><pre class="listing">
<span class="Keyword">int</span> <span class="Identifier">retryCountMax</span> <span class="Operator">=</span> <span class="DecNumber">3</span><span class="Punctuation">;</span>
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">retry</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">Task</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Punctuation">,</span> <span class="Identifier">Object</span><span class="Operator">&gt;</span><span class="Punctuation">)</span> <span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// This task will be executed retryCountMax times at most. If successful, it will not be retried.</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">retryCountMax</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Success, consume the data</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Entering this branch means that all three retries failed.</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span></pre></p>
<p>We can specify a <strong>retry strategy</strong>, such as not retrying if there is no network, or retrying at different intervals each time to avoid causing server pressure.</p>
<p><pre class="listing">
<span class="Keyword">int</span> <span class="Identifier">retryCountMax</span> <span class="Operator">=</span> <span class="DecNumber">3</span><span class="Punctuation">;</span>
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">retry</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">Task</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Punctuation">,</span> <span class="Identifier">Object</span><span class="Operator">&gt;</span><span class="Punctuation">)</span> <span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// This task will be executed retryCountMax times at most. If successful, it will not be retried.</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">retryCountMax</span><span class="Punctuation">,</span> <span class="Keyword">new</span> <span class="Identifier">RetryStrategy</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
    <span class="Operator">@</span><span class="Identifier">Override</span>
    <span class="Keyword">public</span> <span class="Identifier">Timeout</span> <span class="Identifier">delay</span><span class="Punctuation">(</span><span class="Keyword">int</span> <span class="Identifier">retrySeq</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Comment">// Specify the interval between each retry</span>
        <span class="Comment">// Here to achieve the effect of retrying at intervals of 1s, 2s, 3s...</span>
        <span class="Keyword">return</span> <span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofSeconds</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Keyword">long</span><span class="Punctuation">)</span> <span class="Identifier">retrySeq</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span>
    
    <span class="Operator">@</span><span class="Identifier">Override</span>
    <span class="Keyword">public</span> <span class="Keyword">boolean</span> <span class="Identifier">condition</span><span class="Punctuation">(</span><span class="Keyword">int</span> <span class="Identifier">attemptsRemain</span><span class="Punctuation">,</span> <span class="Identifier">Throwable</span> <span class="Identifier">throwable</span><span class="Punctuation">,</span> <span class="Identifier">Object</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Comment">// If this method returns true, continue to retry, return false to abort the retry.</span>
        <span class="Comment">// The input parameters include the current number of retries and the error cause of the last retry.</span>
        <span class="Keyword">return</span> <span class="Keyword">true</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Success, consume the data</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Entering this branch means that all three retries failed.</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span></pre></p>
<p>There are two commonly used retry strategies built into the component. If no retry strategy parameters are specified, the default <strong>Default</strong> retry strategy is used, specifically <strong>retry at a fixed interval of 1 second until the maximum number of retries</strong>.</p>
<p><pre class="listing">
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">retry</span><span class="Punctuation">(</span><span class="Punctuation">.</span><span class="Punctuation">.</span><span class="Punctuation">.</span><span class="Punctuation">,</span> <span class="Identifier">retryMaxCount</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Comment">// Equivalent to</span>
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">retry</span><span class="Punctuation">(</span><span class="Punctuation">.</span><span class="Punctuation">.</span><span class="Punctuation">.</span><span class="Punctuation">,</span> <span class="Identifier">retryMaxCount</span><span class="Punctuation">,</span><span class="Identifier">RetryStrategy</span><span class="Punctuation">.</span><span class="Identifier">Default</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>The two built-in retry strategies are implemented as follows. This interface can also be extended to implement a custom strategy more suitable for the business.</p>
<p><pre class="listing">
<span class="Keyword">public</span> <span class="Keyword">interface</span> <span class="Identifier">RetryStrategy</span> <span class="Punctuation">{</span>
    <span class="Keyword">default</span> <span class="Identifier">Timeout</span> <span class="Identifier">delay</span><span class="Punctuation">(</span><span class="Keyword">int</span> <span class="Identifier">retrySeq</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Keyword">return</span> <span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofSeconds</span><span class="Punctuation">(</span><span class="DecNumber">1</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span>
    <span class="Keyword">default</span> <span class="Keyword">boolean</span> <span class="Identifier">condition</span><span class="Punctuation">(</span><span class="Keyword">int</span> <span class="Identifier">attemptsRemain</span><span class="Punctuation">,</span> <span class="Identifier">Throwable</span> <span class="Identifier">throwable</span><span class="Punctuation">,</span> <span class="Identifier">Object</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Keyword">return</span> <span class="Keyword">true</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span>
    
    <span class="Identifier">RetryStrategy</span> <span class="Identifier">Default</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">RetryStrategy</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">{</span><span class="Punctuation">}</span><span class="Punctuation">;</span>
    <span class="Identifier">RetryStrategy</span> <span class="Identifier">Common</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">RetryStrategy</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Operator">@</span><span class="Identifier">Override</span>
        <span class="Keyword">public</span> <span class="Identifier">Timeout</span> <span class="Identifier">delay</span><span class="Punctuation">(</span><span class="Keyword">int</span> <span class="Identifier">retrySeq</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
            <span class="Keyword">return</span> <span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofSeconds</span><span class="Punctuation">(</span><span class="DecNumber">2L</span><span class="Operator">*</span> <span class="Identifier">retrySeq</span><span class="Punctuation">)</span><span class="Punctuation">;</span><span class="Comment">//2,4,6,8 etc...</span>
        <span class="Punctuation">}</span>
    <span class="Punctuation">}</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span></pre></p>
<p>Likewise, this method returns a new Promise object.</p>
<blockquote class="markdown-quote"><p>Note that when using this interface, the number of retries must be controlled within a reasonable range. Generally, 3 to 5 retries can meet most needs. This interface is not suitable for long-term retry or infinite retry scenarios. It is recommended to use <tt class="docutils literal"><span class="pre"><span class="Identifier">TimerTask</span></span></tt> to further encapsulate Promise. Please refer to the following example.</p></blockquote>
<p><pre class="listing">
<span class="LongComment">/**
* Retry a task at a fixed interval until it is actively canceled or times out.
* If timeout is set to null, which means the task will never time out.
* @param task The task to be executed
* @param periodMills retry interval, in milliseconds
* @param timeout timeout, which can be null, which means the task will never timeout.
**/</span>
<span class="Keyword">public</span> <span class="Keyword">static</span> <span class="Operator">&lt;</span><span class="Identifier">T</span><span class="Operator">&gt;</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">T</span><span class="Operator">&gt;</span> <span class="Identifier">fixRateRepeat</span><span class="Punctuation">(</span><span class="Identifier">Supplier</span><span class="Operator">&lt;</span><span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">T</span><span class="Operator">&gt;&gt;</span> <span class="Identifier">task</span><span class="Punctuation">,</span> <span class="Keyword">long</span> <span class="Identifier">periodMills</span><span class="Punctuation">,</span>  <span class="Identifier">Timeout</span> <span class="Identifier">timeout</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
    <span class="Identifier">Timer</span> <span class="Identifier">t</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">Timer</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">TimerTask</span> <span class="Identifier">tt</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">TimerTask</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Operator">@</span><span class="Identifier">Override</span>
        <span class="Keyword">public</span> <span class="Keyword">void</span> <span class="Identifier">run</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
            <span class="Identifier">task</span><span class="Punctuation">.</span><span class="Identifier">get</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
        <span class="Punctuation">}</span>
    <span class="Punctuation">}</span><span class="Punctuation">;</span>
    <span class="Identifier">Deferred</span><span class="Operator">&lt;</span><span class="Identifier">T</span><span class="Operator">&gt;</span> <span class="Identifier">deferred</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">Deferred</span><span class="Operator">&lt;</span><span class="Identifier">T</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Identifier">timeout</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">timeout</span> <span class="Operator">!=</span> <span class="Keyword">null</span><span class="Punctuation">)</span> <span class="Punctuation">{</span><span class="Comment">// timeoutä»Žofferæ–¹æ³•è°ƒåº¦åŽå¼€å§‹è®¡ç®—</span>
        <span class="Identifier">deferred</span><span class="Punctuation">.</span><span class="Identifier">offer</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span><span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span>
    <span class="Identifier">deferred</span><span class="Punctuation">.</span><span class="Identifier">done</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Identifier">tt</span><span class="Punctuation">.</span><span class="Identifier">cancel</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Identifier">t</span><span class="Punctuation">.</span><span class="Identifier">scheduleAtFixedRate</span><span class="Punctuation">(</span><span class="Identifier">tt</span><span class="Punctuation">,</span> <span class="DecNumber">0</span><span class="Punctuation">,</span> <span class="Identifier">periodMills</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Keyword">return</span> <span class="Identifier">deferred</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span></pre></p>

<h2><a class="toc-backref" id="utilities-validation" href="#utilities-validation">validation</a></h2><p><span id="validation_1">validation</span> further verify the data and return a new Promise object representing the verification result.</p>
<p><pre class="listing">
<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">resolve</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span>
       <span class="Punctuation">.</span><span class="Identifier">validate</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Identifier">s</span><span class="Punctuation">.</span><span class="Identifier">length</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">==</span> <span class="DecNumber">9</span><span class="Punctuation">)</span>
       <span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
           <span class="Comment">//The result is legal</span>
       <span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
           <span class="Comment">//If the verification fails, the error type is ValidationFailedException.</span>
       <span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>
<p>We can collect and store commonly used data verification rules for use at any time, and combine them with Promise to achieve more powerful effects.</p>
<p><pre class="listing">
<span class="Comment">//The following rules verify that the input string cannot be empty, and the length must be greater than 5</span>
<span class="Identifier">Validation</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span> <span class="Identifier">ensureStrLengthIsFive</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">Validation</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">)</span> <span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Identifier">o</span> <span class="Operator">!=</span> <span class="Keyword">null</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="DecNumber">1001</span><span class="Punctuation">,</span> <span class="StringLit">&quot;string is null&quot;</span><span class="Punctuation">)</span>
    <span class="Punctuation">.</span><span class="Identifier">andThen</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">Validation</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">)</span> <span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Identifier">s</span><span class="Punctuation">.</span><span class="Identifier">length</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">&gt;</span> <span class="DecNumber">5</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="DecNumber">1002</span><span class="Punctuation">,</span><span class="StringLit">&quot;string length not corrent&quot;</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">;</span>

<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">resolve</span><span class="Punctuation">(</span><span class="StringLit">&quot;hi&quot;</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">validate</span><span class="Punctuation">(</span><span class="Identifier">ensureStrLengthIsFive</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Keyword">if</span> <span class="Punctuation">(</span><span class="Identifier">error</span> <span class="Keyword">instanceof</span> <span class="Identifier">ValidationFailedException</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Keyword">long</span> <span class="Identifier">errCode</span> <span class="Operator">=</span> <span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">ValidationFailedException</span><span class="Punctuation">)</span> <span class="Identifier">error</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">getErrorCode</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Comment">// Error code 1002</span>
        <span class="Identifier">String</span> <span class="Identifier">errMsg</span> <span class="Operator">=</span> <span class="Identifier">error</span><span class="Punctuation">.</span><span class="Identifier">getMessage</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Comment">// Corresponding error message</span>
    <span class="Punctuation">}</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>

<span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">resolve</span><span class="Punctuation">(</span><span class="StringLit">&quot;something&quot;</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">validate</span><span class="Punctuation">(</span><span class="Identifier">ensureStrLengthIsFive</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">then</span><span class="Punctuation">(</span><span class="Identifier">s</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
  <span class="Comment">// ok meets the requirements and passes the verification</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span></pre></p>

<h1><a class="toc-backref" id="control-flow" href="#control-flow">Control Flow</a></h1>
<h2><a class="toc-backref" id="control-flow-join" href="#control-flow-join">join</a></h2><p><span id="join_1">join</span> Convert asynchronous operations to synchronization. In some scenarios, we may need to obtain the execution results of a task synchronously. In the event that asynchronous execution fails, this method will throw a <tt class="docutils literal"><span class="pre"><span class="Identifier">PromiseException</span></span></tt>, with the following possible situations.</p>
<ul class="simple"><li><tt class="docutils literal"><span class="pre"><span class="Identifier">PromiseCompleteException</span></span></tt></li>
</ul>
<p>The asynchronous task execution failed, that is, the asynchronous task called the <strong>reject.apply</strong> method.</p>
<ul class="simple"><li><tt class="docutils literal"><span class="pre"><span class="Identifier">PromiseTimeoutException</span></span></tt></li>
</ul>
<p>The asynchronous task execution times out. <strong>Each promise can specify a timeout period</strong>. If the status reversal is not completed within the specified time, this exception will be thrown.</p>
<ul class="simple"><li><tt class="docutils literal"><span class="pre"><span class="Identifier">PromiseException</span></span></tt></li>
</ul>
<p>Other exceptions that occur during asynchronous task execution, such as NP, etc. <strong>Exceptions that occur during the execution of Promise will be caught</strong> to ensure that it will not cause the program to crash.</p>
<p><pre class="listing">
<span class="Identifier">String</span> <span class="Identifier">s</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Asynchronous tasks</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">join</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Comment">//If no exception occurs, process s here</span></pre></p>

<h2><a class="toc-backref" id="control-flow-abort" href="#control-flow-abort">abort</a></h2><p><span id="abort_1">abort</span> Abort the task, its execution result depends on the status of the current Promise. For a Promise that is already in the <strong>Done</strong> state, it has no effect, otherwise it will be immediately reversed to the Reject state.</p>
<p>Traditional Promise does not have an interface that supports cancellation. TC39 officially <a class="reference external" href="https://github.com/tc39/proposal-cancelable-promises">had a proposal</a> but it has been rejected. The current official solution is to use <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController/abort">AbortController</a> in conjunction with Promise to implement the cancellation function. In actual use, a single Promised object is acceptable, but in chain calls, it is difficult for us to know at what stage the asynchronous task execution has reached, which Promise object should be canceled, or even the reference to the Promise object cannot be obtained.</p>
<p>In addition, there are also solutions to use a cancelable promise object wrapped by the <tt class="docutils literal"><span class="pre"><span class="Identifier">Promise</span><span class="Operator">.</span><span class="Identifier">race</span></span></tt> interface, such as <a class="reference external" href="https://stackoverflow.com/questions/30233302/promise-is-it -possible-to-force-cancel-a-promise">a discussion on SF</a>. The author believes that this solution is relatively cumbersome to use and the code is not very readable.</p>
<p>In our implementation, canceling a Promise is very simple. You only need to call the abort method of the Promise object. With one call, you can easily cancel the entire Promise chain, and by the way, <a class="reference internal" href="#Structured Concurrency">Structured Concurrency</a> is achieved (<a class="reference external" href="https://en.wikipedia">https://en.wikipedia</a> .org/wiki/Structured_concurrency).</p>
<p><pre class="listing">
<span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">Void</span><span class="Operator">&gt;</span> <span class="Identifier">promise</span> <span class="Operator">=</span> <span class="Identifier">Promise</span><span class="Punctuation">.</span><span class="Identifier">delay</span><span class="Punctuation">(</span><span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofMillis</span><span class="Punctuation">(</span><span class="DecNumber">2000</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Keyword">null</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Identifier">promise</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//The error type is AbortException</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">done</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//The o type is PromiseException, and the object type returned by getCause is AbortException.</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Identifier">promise</span><span class="Punctuation">.</span><span class="Identifier">abort</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Comment">//Task cancellation</span></pre></p>
<p>After the abort interface is called, the abort event will propagate throughout the asynchronous task chain and cancel the entire task chain. For example, in the above code, after the Promise is canceled, if the 2000ms timer resource has not been applied for, it will no longer be applied for. If it has been applied for, the timer resource will be automatically released.</p>
<p>Developers can also implement the aftermath of resource release by overriding the <tt class="docutils literal"><span class="pre"><span class="Identifier">onAbort</span></span></tt> method. The following code example demonstrates the combination with OKHttp.</p>
<p><pre class="listing">
<span class="Identifier">AbortController</span> <span class="Identifier">controller</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">AbortController</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">Integer</span><span class="Operator">&gt;</span> <span class="Identifier">promise</span> <span class="Operator">=</span> <span class="Keyword">new</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">Integer</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">reject</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">// Register the operation of cleaning up resources</span>
    <span class="Identifier">controller</span><span class="Punctuation">.</span><span class="Identifier">signal</span><span class="Punctuation">.</span><span class="Identifier">onAbort</span><span class="Punctuation">(</span><span class="Identifier">reason</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
        <span class="Comment">// Multi-thread resource competition needs to be considered here</span>
        <span class="Comment">// Because sending HTTP requests and canceling HTTP requests may not be in the same thread.</span>
        <span class="Identifier">OkHttpUtils</span><span class="Punctuation">.</span><span class="Identifier">cancelCall</span><span class="Punctuation">(</span><span class="Identifier">client</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Comment">// Send HTTP request (synchronous method, time-consuming operation)</span>
    <span class="Identifier">Response</span> <span class="Identifier">response</span> <span class="Operator">=</span> <span class="Identifier">client</span><span class="Punctuation">.</span><span class="Identifier">newCall</span><span class="Punctuation">(</span><span class="Identifier">request</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">execute</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
    <span class="Comment">// Use resources</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="Identifier">response</span><span class="Punctuation">.</span><span class="Identifier">code</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
    <span class="Operator">@</span><span class="Identifier">Override</span>
    <span class="Keyword">public</span> <span class="Keyword">void</span> <span class="Identifier">onAbort</span><span class="Punctuation">(</span><span class="Identifier">String</span> <span class="Identifier">reason</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Identifier">controller</span><span class="Punctuation">.</span><span class="Identifier">abort</span><span class="Punctuation">(</span><span class="Identifier">reason</span><span class="Punctuation">)</span><span class="Punctuation">;</span>
    <span class="Punctuation">}</span>
<span class="Punctuation">}</span><span class="Punctuation">.</span><span class="Identifier">except</span><span class="Punctuation">(</span><span class="Punctuation">(</span><span class="Identifier">error</span><span class="Punctuation">,</span> <span class="Identifier">o</span><span class="Punctuation">)</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//The error type is AbortException</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">.</span><span class="Identifier">done</span><span class="Punctuation">(</span><span class="Identifier">o</span> <span class="Operator">-&gt;</span> <span class="Punctuation">{</span>
    <span class="Comment">//The o type is PromiseException, and the object type returned by getCause is AbortException.</span>
<span class="Punctuation">}</span><span class="Punctuation">)</span><span class="Punctuation">;</span>

<span class="Identifier">promise</span><span class="Punctuation">.</span><span class="Identifier">abort</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">;</span> <span class="Comment">// Task cancellation</span></pre></p>
<p>Example of use in Kotlin.</p>
<p><pre class="listing">
<span class="Comment">//Create an AbortController object</span>
<span class="Identifier">val</span> <span class="Identifier">abortController</span> <span class="Operator">=</span> <span class="Identifier">AbortController</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Comment">//Create a Promise object</span>
<span class="Identifier">val</span> <span class="Identifier">promise</span> <span class="Operator">=</span> <span class="Identifier">object</span> <span class="Punctuation">:</span> <span class="Identifier">Promise</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Operator">&gt;</span><span class="Punctuation">(</span><span class="Identifier">Task</span><span class="Operator">&lt;</span><span class="Identifier">String</span><span class="Punctuation">,</span> <span class="Identifier">Any</span><span class="Operator">&gt;</span> <span class="Punctuation">{</span> <span class="Identifier">resolve</span><span class="Punctuation">,</span> <span class="Identifier">_</span> <span class="Operator">-&gt;</span>
    <span class="Identifier">val</span> <span class="Identifier">t1</span> <span class="Operator">=</span> <span class="Identifier">Thread</span><span class="Punctuation">.</span><span class="Identifier">currentThread</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
    <span class="Identifier">abortController</span><span class="Punctuation">.</span><span class="Identifier">signal</span><span class="Punctuation">.</span><span class="Identifier">onAbort</span> <span class="Punctuation">{</span>
        <span class="Identifier">t1</span><span class="Punctuation">.</span><span class="Identifier">interrupt</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
    <span class="Punctuation">}</span>
      <span class="Comment">//simulate a time consuming task</span>
    <span class="Keyword">try</span> <span class="Punctuation">{</span>
        <span class="Identifier">Thread</span><span class="Punctuation">.</span><span class="Identifier">sleep</span><span class="Punctuation">(</span><span class="DecNumber">2000</span><span class="Punctuation">)</span>
    <span class="Punctuation">}</span> <span class="Keyword">catch</span> <span class="Punctuation">(</span><span class="Identifier">e</span><span class="Punctuation">:</span> <span class="Identifier">InterruptedException</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Identifier">Log</span><span class="Punctuation">.</span><span class="Identifier">d</span><span class="Punctuation">(</span><span class="Identifier">TAG</span><span class="Punctuation">,</span> <span class="StringLit">&quot;InterruptedException: $e&quot;</span><span class="Punctuation">)</span>
    <span class="Punctuation">}</span>
    <span class="Identifier">resolve</span><span class="Punctuation">.</span><span class="Identifier">apply</span><span class="Punctuation">(</span><span class="StringLit">&quot;SUCCESS&quot;</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span><span class="Punctuation">,</span> <span class="Identifier">Timeout</span><span class="Punctuation">.</span><span class="Identifier">ofMillis</span><span class="Punctuation">(</span><span class="DecNumber">3000</span><span class="Punctuation">)</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
    <span class="Identifier">override</span> <span class="Identifier">fun</span> <span class="Identifier">onAbort</span><span class="Punctuation">(</span><span class="Identifier">reason</span><span class="Punctuation">:</span> <span class="Identifier">String</span><span class="Operator">?</span><span class="Punctuation">)</span> <span class="Punctuation">{</span>
        <span class="Identifier">abortController</span><span class="Punctuation">.</span><span class="Identifier">abort</span><span class="Punctuation">(</span><span class="Identifier">reason</span><span class="Punctuation">)</span>
    <span class="Punctuation">}</span>
<span class="Punctuation">}</span><span class="Punctuation">.</span><span class="Identifier">then</span> <span class="Punctuation">{</span>
    <span class="Identifier">Log</span><span class="Punctuation">.</span><span class="Identifier">d</span><span class="Punctuation">(</span><span class="Identifier">TAG</span><span class="Punctuation">,</span> <span class="StringLit">&quot;then&quot;</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span><span class="Punctuation">.</span><span class="Identifier">except</span> <span class="Punctuation">{</span> <span class="Identifier">throwable</span><span class="Punctuation">:</span> <span class="Identifier">Throwable</span><span class="Operator">?</span><span class="Punctuation">,</span> <span class="Identifier">any</span><span class="Punctuation">:</span> <span class="Identifier">Any</span><span class="Operator">?</span> <span class="Operator">-&gt;</span>
    <span class="Identifier">Log</span><span class="Punctuation">.</span><span class="Identifier">d</span><span class="Punctuation">(</span><span class="Identifier">TAG</span><span class="Punctuation">,</span> <span class="StringLit">&quot;except $throwable $any&quot;</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span><span class="Punctuation">.</span><span class="Identifier">done</span> <span class="Punctuation">{</span>
    <span class="Identifier">Log</span><span class="Punctuation">.</span><span class="Identifier">d</span><span class="Punctuation">(</span><span class="Identifier">TAG</span><span class="Punctuation">,</span> <span class="StringLit">&quot;done&quot;</span><span class="Punctuation">)</span>
<span class="Punctuation">}</span>

<span class="Comment">//Abort Promise execution when needed</span>
<span class="Identifier">promise</span><span class="Punctuation">.</span><span class="Identifier">abort</span><span class="Punctuation">(</span><span class="Punctuation">)</span></pre></p>

<h1><a class="toc-backref" id="concurrency" href="#concurrency">Concurrency</a></h1>
<h2><a class="toc-backref" id="concurrency-all" href="#concurrency-all">all</a></h2><p><span id="all_1">all</span> Accept any number of Promise objects and execute asynchronous tasks concurrently. If all tasks are successful, if one fails, the entire task is considered a failure.</p>

<h2><a class="toc-backref" id="concurrency-race" href="#concurrency-race">race</a></h2><p><span id="race_1">race</span> Accept any number of Promise objects and execute asynchronous tasks concurrently. Time is the first priority. For multiple tasks, the result returned first shall prevail. The success of this result is the overall success, and the failure of this result is the overall failure.</p>

<h2><a class="toc-backref" id="concurrency-any" href="#concurrency-any">any</a></h2><p><span id="any_1">any</span> Accept any number of Promise objects and execute asynchronous tasks concurrently. Waiting for one of them to succeed is considered successful. If all tasks fail, it will enter the error state and output an error list.</p>

<h2><a class="toc-backref" id="concurrency-allsettled" href="#concurrency-allsettled">allSettled</a></h2><p><span id="allsettled_1">allSettled</span> Task priority, all tasks must be executed and will never enter a failed state.</p>
<p>For details, please refer to the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN Promise API Document</a>. The specific implementation is consistent.</p>

<h1><a class="toc-backref" id="memory-model" href="#memory-model">Memory Model</a></h1><p>Asynchronous tasks and multi-thread concurrency are a major problem in business processing. If you are not careful, problems such as crashes, deadlocks, and variable synchronization may occur. Using Promise technology can solve the above two major problems safely and efficiently.</p>
<p>First of all, Promise solves the problem of asynchronous data flow management. In addition, each asynchronous task of Promise is naturally executed by multiple threads. When concurrency is possible, it will be executed concurrently to maximize the running efficiency of the program, such as <tt class="docutils literal"><span class="pre"><span class="Identifier">all</span></span></tt>, <tt class="docutils literal"><span class="pre"><span class="Identifier">race</span></span></tt>, <tt class="docutils literal"><span class="pre"><span class="Identifier">any</span></span></tt> and other interfaces, which abstract common concurrency models.</p>
<p>If we expand here, the length will be relatively long. Here is just a brief explanation. Using Promise mode for asynchronous programming, developers generally do not need to worry about such issues.</p>

<h1><a class="toc-backref" id="other-instructions" href="#other-instructions">Other Instructions</a></h1>
<h2><a class="toc-backref" id="other-instructions-requirements" href="#other-instructions-requirements">Requirements</a></h2><p>Does not rely on any third-party libraries, specific requirements are as follows</p>
<ul class="simple"><li>Java platform: Java version &gt;=1.8</li>
<li>Android platform: Android version &gt;=24 (Nougat)</li>
</ul>
<p>The Android platform can support older Android versions (not yet implemented) via <a class="reference external" href="https://github.com/retrostreams/android-retrofuture">android-retrofuture</a>.</p>

<h2><a class="toc-backref" id="other-instructions-resources" href="#other-instructions-resources">resources</a></h2><ul class="simple"><li>Future/Promise are slightly different, see (<a class="reference external" href="https://en.wikipedia.org/wiki/Futures_and_promises">https://en.wikipedia.org/wiki/Futures_and_promises</a>) for details</li>
<li>Google implemented the Swift version of the Promise library (<a class="reference external" href="https://github.com/google/promises">https://github.com/google/promises</a>)</li>
<li><a class="reference external" href="https://github.com/ReactiveX/RxJava">RxJava</a> A reactive programming, a programming model based on the concept of asynchronous data flow.</li>
<li>Promise specification <a class="reference external" href="https://promisesaplus.com/">Promise A+</a>.</li>
<li><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN Promise API Documentation</a>.</li>
<li><a class="reference external" href="https://promisesaplus.com/">Promise A+ Specification</a></li>
</ul>
</p>
    
  </div>
</div>

      <div class="twelve-columns footer"><small style="color: var(--hint);">Copyright Â© 2024 pro4j.com.</small></div>
    </div>
  </div>
  
  <!-- Google fonts -->
  <link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-39TC9XREHY"></script>
  <script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-39TC9XREHY');</script>
  </body>
</html>
